%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
 \ifdefined\DeclareUnicodeCharacterAsOptional
  \DeclareUnicodeCharacter{"00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{"2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{"2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{"2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{"251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{"2572}{\textbackslash}
 \else
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{2572}{\textbackslash}
 \fi
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage[dontkeepoldnames]{sphinx}

\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.}}
\addto\captionsenglish{\renewcommand{\tablename}{Table}}
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{1}



\title{Beremiz Documentation}
\date{Aug 26, 2020}
\release{1.1rc1}
\author{Beremiz Documentation Authors}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Release}
\makeindex

\begin{document}

\maketitle
\sphinxtableofcontents
\phantomsection\label{\detokenize{index::doc}}


Contents:


\chapter{Project overview}
\label{\detokenize{overview:project-overview}}\label{\detokenize{overview::doc}}\label{\detokenize{overview:beremiz-s-documentation}}
In order to target the widest possible range of programmable devices and keep efficient, Beremiz use C code as an intermediate language.

To be executed, C needs to be compiled. \sphinxhref{http://gcc.gnu.org}{GCC} serve that purpose perfectly.

PLC program is expressed in languages defined in IEC-61131, including graphical languages. Thanks to PLCopen TC2, those graphical languages have a standardised representation, in XML.

To be continued.


\chapter{Beremizâ€™s user manual}
\label{\detokenize{manual/index:beremiz-s-user-manual}}\label{\detokenize{manual/index::doc}}
Contents:


\section{Beremiz installation}
\label{\detokenize{manual/install::doc}}\label{\detokenize{manual/install:beremiz-installation}}

\subsection{Windows}
\label{\detokenize{manual/install:windows}}
Download installer, install.


\subsection{Linux}
\label{\detokenize{manual/install:linux}}
Pre-requisites:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Ubuntu/Debian :}
\PYG{n}{sudo} \PYG{n}{apt}\PYG{o}{\PYGZhy{}}\PYG{n}{get} \PYG{n}{install} \PYG{n}{python}\PYG{o}{\PYGZhy{}}\PYG{n}{wxgtk2}\PYG{o}{.}\PYG{l+m+mi}{8} \PYG{n}{pyro} \PYG{n}{mercurial}
\PYG{n}{sudo} \PYG{n}{apt}\PYG{o}{\PYGZhy{}}\PYG{n}{get} \PYG{n}{install} \PYG{n}{build}\PYG{o}{\PYGZhy{}}\PYG{n}{essential} \PYG{n}{bison} \PYG{n}{flex} \PYG{n}{python}\PYG{o}{\PYGZhy{}}\PYG{n}{numpy} \PYG{n}{python}\PYG{o}{\PYGZhy{}}\PYG{n}{nevow}
\end{sphinxVerbatim}

Prepare:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{mkdir} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}
\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}
\end{sphinxVerbatim}

Get Source Code:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}

\PYG{n}{hg} \PYG{n}{clone} \PYG{n}{http}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{dev}\PYG{o}{.}\PYG{n}{automforge}\PYG{o}{.}\PYG{n}{net}\PYG{o}{/}\PYG{n}{beremiz}
\PYG{n}{hg} \PYG{n}{clone} \PYG{n}{http}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{dev}\PYG{o}{.}\PYG{n}{automforge}\PYG{o}{.}\PYG{n}{net}\PYG{o}{/}\PYG{n}{plcopeneditor}
\PYG{n}{hg} \PYG{n}{clone} \PYG{n}{http}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{dev}\PYG{o}{.}\PYG{n}{automforge}\PYG{o}{.}\PYG{n}{net}\PYG{o}{/}\PYG{n}{matiec}
\end{sphinxVerbatim}

Build MatIEC compiler:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}\PYG{o}{/}\PYG{n}{matiec}
\PYG{o}{.}\PYG{o}{/}\PYG{n}{configure}
\PYG{n}{make}
\end{sphinxVerbatim}

Build CanFestival (optional):

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Only needed for CANopen support. Please read CanFestival}
\PYG{c+c1}{\PYGZsh{} manual to choose CAN interface other than \PYGZsq{}virtual\PYGZsq{}::}

\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}
\PYG{n}{hg} \PYG{n}{clone} \PYG{n}{http}\PYG{p}{:}\PYG{o}{/}\PYG{o}{/}\PYG{n}{dev}\PYG{o}{.}\PYG{n}{automforge}\PYG{o}{.}\PYG{n}{net}\PYG{o}{/}\PYG{n}{CanFestival}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}

\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}\PYG{o}{/}\PYG{n}{CanFestival}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{3}
\PYG{o}{.}\PYG{o}{/}\PYG{n}{configure} \PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZhy{}}\PYG{n}{can}\PYG{o}{=}\PYG{n}{virtual}
\PYG{n}{make}
\end{sphinxVerbatim}

Launch Beremiz:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cd} \PYG{o}{\PYGZti{}}\PYG{o}{/}\PYG{n}{Beremiz}\PYG{o}{/}\PYG{n}{beremiz}
\PYG{n}{python} \PYG{n}{Beremiz}\PYG{o}{.}\PYG{n}{py}
\end{sphinxVerbatim}


\section{Start a new automation project}
\label{\detokenize{manual/start:start-a-new-automation-project}}\label{\detokenize{manual/start::doc}}

\section{Write your own POUs}
\label{\detokenize{manual/edit::doc}}\label{\detokenize{manual/edit:write-your-own-pous}}

\section{Build PLC executable binary}
\label{\detokenize{manual/build::doc}}\label{\detokenize{manual/build:build-plc-executable-binary}}

\section{Beremiz and Beremiz\_service connectors}
\label{\detokenize{manual/connectors:beremiz-and-beremiz-service-connectors}}\label{\detokenize{manual/connectors::doc}}\begin{description}
\item[{To connect a PLC, Beremiz provides 2 types of connectors :}] \leavevmode\begin{itemize}
\item {} 
a Pyro connector

\item {} 
a WAMP connector

\end{itemize}

\end{description}

To configure the connection, you have to set the \sphinxstyleemphasis{URI\_location} in your project Config tab according to this documentation.


\subsection{The Pyro connector}
\label{\detokenize{manual/connectors:the-pyro-connector}}
Pyro is an advanced and powerful Distributed Object Technology system written entirely in Python.
Beremiz\_service spawns a Pyro server, serving a PLCObject (see runtime/PLCObject.py). Therefore, Beremiz acts as a Pyro client.

TODO:: link to PLCObject API documentation
\begin{description}
\item[{URI\_location :}] \leavevmode\begin{itemize}
\item {} 
LOCAL:// is a facility that starts the PLC service locally and connect Beremiz to it via Pyro.
This is intended for use in development stage.

\item {} 
PYRO://\textless{}ip:port\textgreater{} normal connection to a remote PLC. PLC default port is 3000.

\item {} 
PYROS://\textless{}ip:port\textgreater{} SSL connection to a remote PLC, see below.

\end{itemize}

\end{description}

more information about Pyro can be found on \sphinxurl{http://pythonhosted.org//Pyro/1-intro.html}


\subsubsection{Setup a Pyro SSL connection}
\label{\detokenize{manual/connectors:setup-a-pyro-ssl-connection}}
Pyro v3 has a limited TLS/SSL support based on m2crypto. Pyro v4 had dropped it.
In order to have a full and reliable SSL, we recommand to use a TLS/SSL wrapper as nginx, stub or stunnel.


\paragraph{TLS-PSK with stunnel}
\label{\detokenize{manual/connectors:tls-psk-with-stunnel}}
In this example, we setup a simple TLS-PSK connection according to rfc4279.
This ciphersuite avoid the need for public key operations and certificate management.
It is perfect for a performance-constrained environments with limited CPU power as a PLC.
\begin{description}
\item[{Needed :}] \leavevmode\begin{itemize}
\item {} 
stunnel \textgreater{}= 5.09

\end{itemize}

\end{description}

verify openssl support for PSK cipher:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{openssl} \PYG{n}{ciphers} \PYG{o}{\PYGZhy{}}\PYG{n}{v} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{PSK}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}


\paragraph{Client setup (Beremiz)}
\label{\detokenize{manual/connectors:client-setup-beremiz}}
You need to choose an identity for your client, here \sphinxstyleemphasis{client1}.
generate a valid and strong key:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} echo client1:\PYGZdl{}(openssl rand \PYGZhy{}base64 48) \PYGZgt{} pskclient1.txt
\end{sphinxVerbatim}

write a stunnel client configuration file \sphinxstyleemphasis{stunnel-client.conf}:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{output} \PYG{o}{=} \PYG{n}{stunnel}\PYG{o}{\PYGZhy{}}\PYG{n}{client}\PYG{o}{.}\PYG{n}{log}
\PYG{n}{client} \PYG{o}{=} \PYG{n}{yes}

\PYG{p}{[}\PYG{n}{beremiz}\PYG{p}{]}
\PYG{n}{accept} \PYG{o}{=} \PYG{l+m+mi}{3002}
\PYG{n}{connect} \PYG{o}{=} \PYG{p}{[}\PYG{n}{PLC}\PYG{p}{]}\PYG{p}{:}\PYG{l+m+mi}{3001}
\PYG{n}{PSKidentity} \PYG{o}{=} \PYG{n}{client1}
\PYG{n}{PSKsecrets} \PYG{o}{=} \PYG{n}{pskclient1}\PYG{o}{.}\PYG{n}{txt}
\end{sphinxVerbatim}

start stunnel client side:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{stunnel} \PYG{n}{stunnel}\PYG{o}{\PYGZhy{}}\PYG{n}{client}\PYG{o}{.}\PYG{n}{conf}
\end{sphinxVerbatim}

You could now connect beremiz with classic URI\_location = PYRO://127.0.0.1:3002


\paragraph{Server setup (PLC)}
\label{\detokenize{manual/connectors:server-setup-plc}}
import the client key in a keyfile psk.txt, concatening all client key.

write a stunnel server  configuration file \sphinxstyleemphasis{stunnel-server.conf}:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{output} \PYG{o}{=} \PYG{n}{stunnel}\PYG{o}{\PYGZhy{}}\PYG{n}{server}\PYG{o}{.}\PYG{n}{log}

\PYG{p}{[}\PYG{n}{beremiz}\PYG{p}{]}
\PYG{n}{accept} \PYG{o}{=} \PYG{l+m+mi}{3001}
\PYG{n}{connect} \PYG{o}{=} \PYG{l+m+mf}{127.0}\PYG{o}{.}\PYG{l+m+mf}{0.1}\PYG{p}{:}\PYG{l+m+mi}{3000}
\PYG{n}{PSKsecrets} \PYG{o}{=} \PYG{n}{psk}\PYG{o}{.}\PYG{n}{txt}
\end{sphinxVerbatim}

start stunnel server side:

\fvset{hllines={, ,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{stunnel} \PYG{n}{stunnel}\PYG{o}{\PYGZhy{}}\PYG{n}{server}\PYG{o}{.}\PYG{n}{conf}
\end{sphinxVerbatim}

more documentation on stunnel \sphinxurl{http://www.stunnel.org/docs.html}


\subsection{The WAMP connector}
\label{\detokenize{manual/connectors:the-wamp-connector}}
WAMP is an open standard WebSocket subprotocol that provides two application messaging
patterns in one unified protocol: Remote Procedure Calls + Publish \& Subscribe.

Beremiz WAMP connector implementation uses Autobahn and crossbar.
\begin{description}
\item[{URI\_location :}] \leavevmode\begin{itemize}
\item {} 
WAMP://127.0.0.1:8888\#Automation\#2534667845

\end{itemize}

\end{description}

more information about WAMP can be found on \sphinxurl{http://wamp.ws/}


\section{Trace POUs instances variable}
\label{\detokenize{manual/debug:trace-pous-instances-variable}}\label{\detokenize{manual/debug::doc}}

\chapter{IEC 61131-3}
\label{\detokenize{standards:iec-61131-3}}\label{\detokenize{standards::doc}}\begin{quote}

IEC-61131 is a normative document provided by the standards organization IEC
(International Electrotechnical Commission) and describing a standard for
implementing programmable controllers.

The part 3 of this document (commonly named IEC 61131-3) specifies syntax and
semantics for programming language for programmable controllers. Beremiz
implements all the languages described in this document.

\sphinxurl{http://www.iec.eu}
\end{quote}


\chapter{PLCopen TC6}
\label{\detokenize{standards:plcopen-tc6}}\begin{quote}

PLCopen is a vendor- and product-independent worldwide association defining
international standards for various topics related to control programming.
For this purpose, PLCopen has 6 technical committees.

The goal of the sixth committee (TC6) is to define a standard file format,
based on XML, for exchanging programmables controllers programmed using
IEC 61131-3 languages. Beremiz uses this file format for saving the PLC
programs of projects.

\sphinxurl{http://www.plcopen.org}
\end{quote}



\renewcommand{\indexname}{Index}
\printindex
\end{document}