#!/usr/bin/env python
# -*- coding: utf-8 -*-
## Code generated by Beremiz python mixin confnode
##

## Code for PLC global variable access
from targets.typemapping import TypeTranslator
import ctypes
_pythonGlobalsDesc = []
__ext_name__ = "python"
PLCGlobalsDesc.append(( "python" , _pythonGlobalsDesc ))


## User code in "global" scope


import sys, os, string, getopt, thread, socket
from MesPacked import MesPacked

def main():
    global mesPacked
    mesPacked = MesPacked()
    port = PLCGlobals.PORT
    mesPacked.print_message("Listening on port:{0:d}...".format(port), PLCGlobals.INFO)    
    main_thread(port)

def usage(msg=None):
    sys.stdout = sys.stderr
    if msg:
        print msg
    print "\n", __doc__,
    sys.exit(2)


def main_thread(port):
    global mesPacked

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.bind(("localhost", port))
    sock.listen(5)
    while 1:
        (conn, addr) = sock.accept()
        if addr[0] != conn.getsockname()[0]:
            conn.close()
            mesPacked.print_message("Refusing connection from non-local host:{0:s}...".format(addr[0]),
                                    PLCGlobals.ERROR)
            continue
        thread.start_new_thread(service_thread, (conn, addr))
        del conn, addr


def service_thread(conn, addr):
    global mesPacked
    (caddr, cport) = addr
    mesPacked.print_message("Thread {0:s} has connection from {1:s}.".format(str(thread.get_ident()), caddr),
                            PLCGlobals.INFO)
    stdin = conn.makefile("r")
    stdout = conn.makefile("w", 0)
    run_interpreter(stdin, stdout)
    mesPacked.print_message("Thread {0:s} is done.".format(str(thread.get_ident())), PLCGlobals.INFO)


def run_interpreter(stdin, stdout):
    global mesPacked
    data = stdin.readline()
    mesPacked.recvMessage(data)
    stdout.write(mesPacked.b_message)

def getValue():
    global mesPacked
    return str(mesPacked.b_message)





## Beremiz python runtime calls
def _runtime_0_init():
    print "python init section..."

def _runtime_0_cleanup():
    pass

def _runtime_0_start():
    messageErr="py_runtime start..."
    print "Debug: ", PLCGlobals.debug
    print "Bases: ", PLCGlobals.PATH
    print "Host: ", PLCGlobals.host
    print "Port ", PLCGlobals.PORT

def _runtime_0_stop():
    print "py_runtime stop"



del __ext_name__

