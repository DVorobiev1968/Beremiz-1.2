/* Code generated by Beremiz c_ext confnode */

/* User includes */
#include "stdio.h"
#include "iec_types.h"/* Beremiz c_ext confnode user variables definition */
IEC_SINT beremiz__IB1_0;
IEC_SINT *__IB1_0 = &beremiz__IB1_0;
IEC_SINT beremiz__QB1_0;
IEC_SINT *__QB1_0 = &beremiz__QB1_0;
/* User variables reference */
#define TestInput beremiz__IB1_0
#define TestOutput beremiz__QB1_0

/* User internal user variables and routines */
volatile long Lock=0;
volatile char PtoC=1,CtoP=2;

int Simple_C_Call(int val){
  return val+1;
}

int Python_to_C_Call(char toC, char *fromC){
  /* Code called by python should never touch to 
     variables modified by PLC thread directly

     AtomicCompareExchange comes from 
     beremiz' runtime implementation */

  int res = 0;
  if(!AtomicCompareExchange(&Lock, 0, 1)){
    PtoC=toC;
    *fromC=CtoP;
    AtomicCompareExchange(&Lock, 1, 0);
    res=1;
  }
  printf("C code called by Python: toC %d fromC %d\n",toC,*fromC);
  return res;
}

int PLC_C_Call(char fromPLC, char *toPLC){
  /* PLC also have to be realy carefull not to 
     conflict with asynchronous python access */
  int res;
  if(!AtomicCompareExchange(&Lock, 0, 1)){
      CtoP = fromPLC;
      *toPLC = PtoC;
      AtomicCompareExchange(&Lock, 1, 0);
      return 1;
  }
  return 0;
}/* Beremiz confnode functions */
int __init_1(int argc,char **argv)
{
  return 0;

}

void __cleanup_1(void)
{

}

void __retrieve_1(void)
{

}

void __publish_1(void)
{
if(!AtomicCompareExchange(&Lock, 0, 1)){
    TestInput = CtoP + PtoC + TestOutput;
    AtomicCompareExchange(&Lock, 1, 0);
}
}

