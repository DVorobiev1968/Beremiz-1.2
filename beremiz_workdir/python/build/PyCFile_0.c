/*
 * Code generated by Beremiz py_ext confnode
 * for safe global variables access
 */
#include "iec_types_all.h"
#include "POUS.h"
#include "config.h"
#include "beremiz.h"

/* User variables reference */
extern  __IEC_INT_t CONF_PYTEST__TEST_PYTHON_VAR;
IEC_INT __Test_Python_Var_rbuffer = __INIT_INT;
IEC_INT __Test_Python_Var_wbuffer;
long __Test_Python_Var_rlock = 0;
long __Test_Python_Var_wlock = 0;
int __Test_Python_Var_wbuffer_written = 0;
void __SafeGetPLCGlob_Test_Python_Var(IEC_INT *pvalue){
    while(AtomicCompareExchange(&__Test_Python_Var_rlock, 0, 1));
    *pvalue = __Test_Python_Var_rbuffer;
    AtomicCompareExchange((long*)&__Test_Python_Var_rlock, 1, 0);
}
void __SafeSetPLCGlob_Test_Python_Var(IEC_INT *value){
    while(AtomicCompareExchange(&__Test_Python_Var_wlock, 0, 1));
    __Test_Python_Var_wbuffer = *value;
    __Test_Python_Var_wbuffer_written = 1;
    AtomicCompareExchange((long*)&__Test_Python_Var_wlock, 1, 0);
}


extern  __IEC_INT_t CONF_PYTEST__SECOND_PYTHON_VAR;
IEC_INT __Second_Python_Var_rbuffer = __INIT_INT;
IEC_INT __Second_Python_Var_wbuffer;
long __Second_Python_Var_rlock = 0;
long __Second_Python_Var_wlock = 0;
int __Second_Python_Var_wbuffer_written = 0;
void __SafeGetPLCGlob_Second_Python_Var(IEC_INT *pvalue){
    while(AtomicCompareExchange(&__Second_Python_Var_rlock, 0, 1));
    *pvalue = __Second_Python_Var_rbuffer;
    AtomicCompareExchange((long*)&__Second_Python_Var_rlock, 1, 0);
}
void __SafeSetPLCGlob_Second_Python_Var(IEC_INT *value){
    while(AtomicCompareExchange(&__Second_Python_Var_wlock, 0, 1));
    __Second_Python_Var_wbuffer = *value;
    __Second_Python_Var_wbuffer_written = 1;
    AtomicCompareExchange((long*)&__Second_Python_Var_wlock, 1, 0);
}



/* Beremiz confnode functions */
int __init_0(int argc,char **argv){

    return 0;
}

void __cleanup_0(void){
}

void __retrieve_0(void){
    if(!AtomicCompareExchange(&__Test_Python_Var_wlock, 0, 1)){
        if(__Test_Python_Var_wbuffer_written == 1){
            CONF_PYTEST__TEST_PYTHON_VAR.value = __Test_Python_Var_wbuffer;
            __Test_Python_Var_wbuffer_written = 0;
        }
        AtomicCompareExchange((long*)&__Test_Python_Var_wlock, 1, 0);
    }

    if(!AtomicCompareExchange(&__Second_Python_Var_wlock, 0, 1)){
        if(__Second_Python_Var_wbuffer_written == 1){
            CONF_PYTEST__SECOND_PYTHON_VAR.value = __Second_Python_Var_wbuffer;
            __Second_Python_Var_wbuffer_written = 0;
        }
        AtomicCompareExchange((long*)&__Second_Python_Var_wlock, 1, 0);
    }

}

void __publish_0(void){
    if(!AtomicCompareExchange(&__Test_Python_Var_rlock, 0, 1)){
        __Test_Python_Var_rbuffer = __GET_VAR(CONF_PYTEST__TEST_PYTHON_VAR);
        AtomicCompareExchange((long*)&__Test_Python_Var_rlock, 1, 0);
    }

    if(!AtomicCompareExchange(&__Second_Python_Var_rlock, 0, 1)){
        __Second_Python_Var_rbuffer = __GET_VAR(CONF_PYTEST__SECOND_PYTHON_VAR);
        AtomicCompareExchange((long*)&__Second_Python_Var_rlock, 1, 0);
    }

}
