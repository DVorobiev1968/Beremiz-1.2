/*
 * Code generated by Beremiz py_ext confnode
 * for safe global variables access
 */
#include "iec_types_all.h"
#include "POUS.h"
#include "config.h"
#include "beremiz.h"

/* User variables reference */
extern  __IEC_INT_t CONFIG__TEST;
IEC_INT __test_rbuffer = __INIT_INT;
IEC_INT __test_wbuffer;
long __test_rlock = 0;
long __test_wlock = 0;
int __test_wbuffer_written = 0;
void __SafeGetPLCGlob_test(IEC_INT *pvalue){
    while(AtomicCompareExchange(&__test_rlock, 0, 1));
    *pvalue = __test_rbuffer;
    AtomicCompareExchange((long*)&__test_rlock, 1, 0);
}
void __SafeSetPLCGlob_test(IEC_INT *value){
    while(AtomicCompareExchange(&__test_wlock, 0, 1));
    __test_wbuffer = *value;
    __test_wbuffer_written = 1;
    AtomicCompareExchange((long*)&__test_wlock, 1, 0);
}



/* Beremiz confnode functions */
int __init_1(int argc,char **argv){

    return 0;
}

void __cleanup_1(void){
}

void __retrieve_1(void){
    if(!AtomicCompareExchange(&__test_wlock, 0, 1)){
        if(__test_wbuffer_written == 1){
            CONFIG__TEST.value = __test_wbuffer;
            __test_wbuffer_written = 0;
        }
        AtomicCompareExchange((long*)&__test_wlock, 1, 0);
    }

}

void __publish_1(void){
    if(!AtomicCompareExchange(&__test_rlock, 0, 1)){
        __test_rbuffer = __GET_VAR(CONFIG__TEST);
        AtomicCompareExchange((long*)&__test_rlock, 1, 0);
    }

}
